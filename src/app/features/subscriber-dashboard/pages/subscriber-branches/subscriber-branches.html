<div class="container">
  <div class="header">
    <h1 class="title">{{ t('branchesList') }}</h1>

    <div class="actions">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" [placeholder]="t('search')" [(ngModel)]="searchTerm">
      </div>

      <button class="btn btn-primary" (click)="openAddBranchModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        {{ t('addNewBranch') }}
      </button>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="w-checkbox">
            <div class="custom-checkbox"
                 [class.checked]="isAllSelected"
                 [class.indeterminate]="isPartiallySelected"
                 (click)="isAllSelected ? toggleAll({target:{checked:false}}) : toggleAll({target:{checked:true}})">
              <svg *ngIf="isAllSelected" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <svg *ngIf="isPartiallySelected" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </div>
          </th>
          <th>{{ t('branchName') }} <span class="sort-arrow">⌄</span></th>
          <th>{{ t('city') }} <span class="sort-arrow">⌄</span></th>
          <th>{{ t('branchManager') }} <span class="sort-arrow">⌄</span></th>
          <th>{{ t('status') }} <span class="sort-arrow">⌄</span></th>
          <th class="w-action"></th>
        </tr>
      </thead>

      <tbody>
<tr *ngFor="let branch of displayedBranches"
    [routerLink]="['../branches-details', branch.id]"
    class="cursor-pointer">          <td>
            <div class="custom-checkbox" [class.checked]="branch.selected" (click)="$event.stopPropagation(); toggleRow(branch)">
              <svg *ngIf="branch.selected" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </td>

          <td class="font-medium">{{ branch.name }}</td>
          <td class="text-gray">{{ branch.city }}</td>
          <td class="text-gray">{{ branch.manager?.fullName || '-' }}</td>

          <td>
            <span class="badge" [ngClass]="branch.status === 'Active' ? 'badge-active' : 'badge-inactive'">
              <span class="dot">●</span> {{ statusLabel(branch.status) }}
            </span>
          </td>

          <td class="text-right action-cell" (click)="$event.stopPropagation()">
            <button class="btn-icon" (click)="toggleMenu(branch.id)">⋮</button>

            <div class="menu" *ngIf="openMenuBranchId === branch.id">
              <button class="menu-item" (click)="openEditBranchModal(branch)">Edit</button>

              <div class="menu-sep"></div>

              <button
                class="menu-item"
                [class.active]="branch.status === 'Active'"
                [disabled]="isUpdatingStatus"
                (click)="updateStatus(branch, 'Active')">
                Active
              </button>

              <button
                class="menu-item"
                [class.active]="branch.status === 'Inactive'"
                [disabled]="isUpdatingStatus"
                (click)="updateStatus(branch, 'Inactive')">
                Inactive
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <div class="page-controls">
      <button class="btn-page text-only" (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1" [style.opacity]="currentPage === 1 ? '0.5' : '1'">
        &lt; {{ t('back') }}
      </button>

      <ng-container *ngFor="let page of visiblePages">
        <span *ngIf="page === '...'" class="dots">...</span>
        <button *ngIf="page !== '...'" class="btn-page" [class.active]="page === currentPage" (click)="changePage(page)">
          {{ page }}
        </button>
      </ng-container>

      <button class="btn-page text-only" (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages" [style.opacity]="currentPage === totalPages ? '0.5' : '1'">
        {{ t('next') }} &gt;
      </button>
    </div>

    <div class="page-jump">
      <span>{{ t('page') }}</span>
      <input type="number" [(ngModel)]="paginationInput" (keyup.enter)="goToInputPage()">
      <span class="go-btn" (click)="goToInputPage()">{{ t('go') }}</span>
    </div>

    <div class="page-summary">
      {{ (currentPage - 1) * itemsPerPage + 1 }}-
      {{ currentPage * itemsPerPage > totalItems ? totalItems : currentPage * itemsPerPage }}
      {{ t('of') }}
      {{ totalItems | number }}
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>{{ mode === 'add' ? 'Add Branch' : 'Edit Branch' }}</h3>
      <button class="close-btn" (click)="closeModal()">✕</button>
    </div>

    <form [formGroup]="branchForm" (ngSubmit)="submitBranch()">

      <!-- STEP 1 -->
      <div *ngIf="currentStep === 1">
        <div class="step-indicator">
          <span class="step-title">Branch Information</span>
          <span class="step-count">Step 1 of 2</span>
        </div>

        <div class="form-group">
          <label>Branch Name</label>
          <input type="text" formControlName="name" placeholder="Enter Branch Name" class="form-input">
          <div class="error" *ngIf="isInvalid('name')">Branch Name is required</div>
        </div>

        <div class="form-group">
          <label>City</label>

          <select formControlName="cityName" class="form-input" [disabled]="isCitiesLoading">
  <option [ngValue]="null" disabled>
    {{ isCitiesLoading ? 'Loading...' : 'Select City' }}
  </option>

  <option *ngFor="let c of cities" [ngValue]="c.name">
    {{ c.name }}
  </option>
</select>

<div class="error" *ngIf="isInvalid('cityName')">City is required</div>
<div class="error" *ngIf="!isCitiesLoading && cities.length === 0">
  No cities found for your country
</div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div *ngIf="currentStep === 2">
        <div class="step-indicator">
          <span class="step-title">Branch Manager</span>
          <span class="step-count">Step 2 of 2</span>
        </div>

        <div class="form-group">
          <label>Branch Manager Name</label>
          <input type="text" formControlName="managerName" placeholder="Enter Branch Manager Name" class="form-input">
          <div class="error" *ngIf="isInvalid('managerName')">Manager name is required</div>
        </div>

        <div class="form-group">
          <label>Work Email</label>
          <input type="email" formControlName="managerEmail" placeholder="Enter Work Email" class="form-input">
          <div class="error" *ngIf="isInvalid('managerEmail')">Enter a valid email</div>
        </div>

        <div class="form-group">
          <label>Work Mobile Number</label>
          <input
            type="text"
            formControlName="managerPhone"
            placeholder="Enter Work Mobile Number"
            class="form-input"
            inputmode="numeric"
            autocomplete="tel"
            (input)="onPhoneInput($event)">
          <div class="error" *ngIf="isInvalid('managerPhone')">
            Phone is required (numbers only)
          </div>
        </div>

        <div class="form-group">
          <label>Start Date</label>
          <input type="date" formControlName="startDate" class="form-input">
          <div class="error" *ngIf="isInvalid('startDate')">Start date is required</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-back" *ngIf="currentStep === 1" (click)="closeModal()">Back</button>
        <button type="button" class="btn-back" *ngIf="currentStep === 2" (click)="prevStep()">Back</button>

        <button type="button" class="btn-next" *ngIf="currentStep === 1" (click)="nextStep()" [disabled]="isCitiesLoading">
          Next
        </button>

        <button type="submit" class="btn-next" *ngIf="currentStep === 2" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Submitting...' : 'Submit' }}
        </button>
      </div>
    </form>
  </div>
</div>
