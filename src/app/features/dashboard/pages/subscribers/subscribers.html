<div class="tabs-container d-flex align-items-center mb-4">
  <div class="tab-item"
       [class.active]="activeTab === 'subscribers'"
       (click)="setActiveTab('subscribers')">
    {{ t('subscribers') }}
  </div>

  <div class="tab-item"
       [class.active]="activeTab === 'renewal'"
       (click)="setActiveTab('renewal')">
    {{ t('renewal') }}
  </div>

</div>

<div class="tab-content">

  <div *ngIf="activeTab === 'subscribers'">
     <div class="row mt-4">
  <div class="col-12">
    <div class="card shadow-sm border-0 px-4">
      <div class="d-flex align-items-center flex-wrap py-4">

        <!-- العنوان وأزرار Edit/Delete -->
        <div class="d-flex align-items-center gap-4 flex-nowrap mx-4">
          <h5 class="mb-0 table-title">{{ t('subscribersTable') }}</h5>
          <div class="d-flex gap-3 text-muted small">
            <span role="button" class="d-flex align-items-center gap-1 hover-primary" (click)="updateSelectedUsers()">
              <i class="fas fa-pen"></i> {{ t('edit') }}
            </span>
            <!-- <span role="button" class="d-flex align-items-center gap-1 hover-danger" (click)="deleteSelectedUsers()">
              <i class="fas fa-trash"></i> {{ t('delete') }}
            </span> -->
             <!-- Status Select -->
              <select class="form-select form-select-sm"
        [disabled]="selectedUsers.length !== 1"
        [(ngModel)]="selectedSubscriberStatus"
        (ngModelChange)="autoUpdateStatus($event)">
                <option value="">Select Status</option>
                <option value="ACTIVE">Active</option>
                <option value="INACTIVE">Inactive</option>
                <option value="PENDING">Pending</option>
              </select>

              <!-- <button class="btn btn-sm btn-primary"
                      [disabled]="selectedUsers.length !== 1 || !selectedSubscriberStatus"
                      (click)="updateSubscriberStatus()">
                Update Status
              </button> -->
          </div>
        </div>

        <!-- البحث والأزرار -->
        <div class="d-flex align-items-center gap-2 flex-nowrap">
          <div class="search-container">
  <input
    type="text"
    [placeholder]="t('search')"
    [(ngModel)]="searchTerm"
    (input)="onSearchChange($event)"
  >
  <i class="fas fa-search search-icon"></i>
</div>
          <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                  (click)="toggleFilter()">
            <i class="fas fa-filter"></i> {{ t('filter') }}
          </button>

          <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2" (click)="openExportModal()">
            <i class="fas fa-cloud-arrow-down"></i> {{ t('export') }}
          </button>

          <button class="btn btn-success btn-sm d-flex align-items-center gap-2" (click)="openAddUserModal()">
            <i class="fas fa-plus"></i> {{ t('addNewUser') }}
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="bg-light">
            <tr class="text-muted small text-uppercase">
              <th scope="col" style="width: 50px;">
                <input type="checkbox" [checked]="allSelected" (change)="toggleAllSelection($event)">
              </th>
              <th scope="col">{{ t('name') }}</th>
              <th scope="col">{{ t('email') }}</th>
              <th scope="col">{{ t('mobile') }}</th>
              <th scope="col">{{ t('country') }}</th>
              <th scope="col">{{ t('city') }}</th>
              <!-- <th scope="col">{{ t('region') }}</th> -->
              <th scope="col">{{ t('LegalEntity') }}</th>
              <th scope="col">{{ t('LicenseNo') }}</th>
              <th scope="col">{{ t('LicenseDate') }}</th>
              <th scope="col">{{ t('Status') }}</th>
              <th scope="col">{{ t('SubscriptionEnd') }}</th>
            </tr>
          </thead>
          <tbody>
  <tr
  *ngFor="let user of subscribers; let i = index"
  class="border-bottom"
  (click)="openSubscriberOverlay(user)"
  style="cursor: pointer;"
>

    <td>
      <input
        type="checkbox"
        [(ngModel)]="user.selected"
        class="custom-checkbox"
        id="chk{{i}}"
        (click)="$event.stopPropagation()"
      />
    </td>
<td class="fw-bold text-dark">{{ user.licenseName }}</td>
<td class="text-muted">{{ user.subscriberEmail }}</td>
<td class="text-muted">{{ user.primaryMobile }}</td>
<td class="text-muted">{{ user.country?.name }}</td>
<td class="text-muted">{{ user.city?.name }}</td>
<!-- <td class="text-muted">{{ user.region?.name }}</td> -->
<td class="text-muted">{{ user.legalEntityType }}</td>
<td class="text-muted">{{ user.licenseNumber }}</td>
<td class="text-muted">{{ user.licenseDate }}</td>
<td class="text-muted">{{ user.status }}</td>
<td class="text-muted">
  {{ user.subscriptionEndDate ? (user.subscriptionEndDate | date:'yyyy-MM-dd') : '—' }}
</td>
  </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 pb-3 px-2">
  <div class="text-muted small">
    {{ (subCurrentPage - 1) * subItemsPerPage + 1 }}-{{ Math.min(subCurrentPage * subItemsPerPage, subTotalItems) }} of {{ subTotalItems }}
  </div>

  <div class="d-flex align-items-center gap-2">
      <button (click)="changePage('sub', subCurrentPage - 1)" [disabled]="subCurrentPage === 1" class="btn btn-outline-light text-dark pagination-btn">Prev</button>
  <button (click)="changePage('sub', subCurrentPage + 1)" [disabled]="subCurrentPage === totalPages" class="btn btn-outline-light text-dark pagination-btn mx-1">Next</button>
    <div class="d-flex gap-1">
      <ng-container *ngFor="let page of subPaginationArray">
  <button *ngIf="page !== '...'"
          class="btn pagination-btn"
          [class.active]="page === subCurrentPage"
          (click)="changePage('sub', +page)">
    {{ page }}
  </button>
  <span *ngIf="page === '...'" class="px-2 text-muted">...</span>
</ng-container>
    </div>

    <div class="d-flex align-items-center gap-2 ms-3">
      <span class="text-muted small">Page</span>
      <input type="number" class="form-control pagination-input" [(ngModel)]="goToPageInput">
      <button class="btn fw-bold text-dark" (click)="goToPage('sub')">Go</button>
    </div>
  </div>
</div>

      </div>
    </div>
  </div>
  <!-- Filter Modal Overlay -->
<div class="filter-overlay" *ngIf="showFilterModal" (click)="closeFilter()" [dir]="currentLang === 'ar' ? 'rtl' : 'ltr'">
  <div class="filter-modal" (click)="$event.stopPropagation()">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="fw-bold mb-0">{{ t('filter') }}</h5>
      <i class="fas fa-times text-muted fs-5" style="cursor: pointer;" (click)="closeFilter()"></i>
    </div>

    <div class="filter-body">

      <!-- Country -->
      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('country') }}</label>
        <select class="form-select text-muted"
                [(ngModel)]="filterData.countryId"
                (change)="onFilterCountryChange()">

          <option value="">{{ t('selectCountry') }}</option>
          <option *ngFor="let c of countries" [value]="c.id">{{ c.name }}</option>

        </select>
      </div>

      <!-- City + Region -->
      <div class="row mb-3">

        <!-- City -->
        <div class="col-6">
          <label class="form-label text-muted small">{{ t('city') }}</label>
          <select class="form-select text-muted"
                  [(ngModel)]="filterData.cityId"
                  (change)="onFilterCityChange()">

            <option value="">{{ t('selectCity') }}</option>
            <option *ngFor="let c of cities" [value]="c.id">{{ c.name }}</option>

          </select>
        </div>

        <!-- Region -->
        <div class="col-6">
          <label class="form-label text-muted small">{{ t('region') }}</label>
          <select class="form-select text-muted"
                  [(ngModel)]="filterData.regionId">

            <option value="">{{ t('selectRegion') }}</option>
            <option *ngFor="let r of regions" [value]="r.id">{{ r.name }}</option>

          </select>
        </div>

      </div>

      <!-- Status -->
      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('status') }}</label>
        <select class="form-select text-muted" [(ngModel)]="filterData.status">
          <option value="">{{ t('selectStatus') }}</option>
          <option value="ACTIVE">{{ t('active') }}</option>
          <option value="INACTIVE">{{ t('inactive') }}</option>
        </select>
      </div>

      <!-- New Subscribers -->
      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('newSubscribers') }}</label>
        <input type="text" class="form-control"
               [(ngModel)]="filterData.newSubscribersDays"
               [placeholder]="t('eg30Days')">
      </div>

      <!-- Subscription Ending -->
      <div class="mb-4">
        <label class="form-label text-muted small">{{ t('subscriptionEnding') }}</label>
        <input type="text" class="form-control"
               [(ngModel)]="filterData.endingSubscriptionDays"
               [placeholder]="t('eg15Days')">
      </div>

    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <button class="btn text-success fw-bold" (click)="resetFilter()">{{ t('reset') }}</button>
      <button class="btn btn-success px-4" (click)="applyFilter()">{{ t('applyFilters') }}</button>
    </div>

  </div>
</div>

</div>
  </div>

  <div *ngIf="activeTab === 'renewal'">
    <div><div class="row mt-4">
  <div class="col-12">
    <div class="card shadow-sm border-0 px-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap py-4">
        <div>
          <h6>{{ t('SubscriptionRenewals') }}</h6>
            <p>{{ t('Monitorrenewal') }}</p>
        </div>
            <div class="d-flex align-items-center reminder">
              <i class="fa-solid fa-recycle"></i>
              <button class="btn btn-white fw-bold" (click)="openReminderModal()">{{ t('reminder') }}</button>
            </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="bg-light">
            <tr class="text-muted small text-uppercase">
              <th scope="col" style="width: 50px;">
<input
  type="checkbox"
  [checked]="allRenSelected"
  (change)="toggleAllRenSelection($event)"
>
              </th>
              <th scope="col">{{ t('name') }}</th>
              <th scope="col">{{ t('email') }}</th>
              <th scope="col">{{ t('mobile') }}</th>
              <th scope="col">{{ t('country') }}</th>
              <th scope="col">{{ t('city') }}</th>
              <th scope="col">{{ t('subscriptionstart') }}</th>
              <th scope="col">{{ t('subscriptionEnd') }}</th>
              <th scope="col">{{ t('lastrenewal') }}</th>
              <th scope="col">{{ t('Status') }}</th>
              <!-- <th scope="col">{{ t('Actions') }}</th> -->
            </tr>
          </thead>
          <tbody>
  <tr *ngFor="let user of renDisplayedItems; let i = index" class="border-bottom">
    <td>
      <input
        type="checkbox"
        [(ngModel)]="user.selected"
        class="custom-checkbox"
        id="chk{{i}}"
      />
    </td>
    <td class="fw-bold text-dark">{{ user.name }}</td>
    <td class="text-muted">{{ user.email }}</td>
    <td class="text-muted">{{ user.phone }}</td>
    <td class="text-muted">{{ user.country }}</td>
    <td class="text-muted">{{ user.city }}</td>
    <td class="text-muted">{{ user.startDate }}</td>
    <td class="text-muted">{{ user.endDate }}</td>
    <td class="text-muted">{{ user.startDate }}</td>
    <td class="text-muted">{{ user.renewalStatus }}</td>
    <td>
      <!-- <button class="btn btn-success btn-sm">
        {{ t('reminder') }}
      </button> -->
  </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 pb-3 px-2">
  <div class="text-muted small">
  {{ (renCurrentPage - 1) * renItemsPerPage + 1 }}-
  {{ Math.min(renCurrentPage * renItemsPerPage, renTotalItems) }}
  of {{ renTotalItems }}
</div>

  <div class="d-flex align-items-center gap-2">
    <div class="d-flex gap-1">
      <button (click)="changePage('ren', renCurrentPage - 1)"
        [disabled]="renCurrentPage === 1"
        class="btn btn-outline-light text-dark pagination-btn">Prev</button>

<button (click)="changePage('ren', renCurrentPage + 1)"
        [disabled]="renCurrentPage === renTotalPages"
        class="btn btn-outline-light text-dark pagination-btn mx-2">Next</button>
  <ng-container *ngFor="let page of renPaginationArray">

    <button *ngIf="page !== '...'"
            class="btn pagination-btn"
            [class.active]="page === renCurrentPage"
            (click)="changePage('ren', +page)">  <!-- تحويل page إلى رقم -->
      {{ page }}
    </button>

    <span *ngIf="page === '...'" class="px-2 text-muted">...</span>

  </ng-container>
</div>

    <div class="d-flex align-items-center gap-2 ms-3">
      <span class="text-muted small">Page</span>
      <input type="number" class="form-control pagination-input" [(ngModel)]="goToPageInput">
      <button class="btn fw-bold text-dark" (click)="goToPage('ren')">Go</button>
    </div>
  </div>
</div>
      </div>
    </div>
  </div>
  <!-- Filter Modal Overlay -->
<div class="filter-overlay" *ngIf="showFilterModal" (click)="closeFilter()">
  <div class="filter-modal" (click)="$event.stopPropagation()">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="fw-bold mb-0">{{ t('filter') }}</h5>
      <i class="fas fa-times text-muted fs-5" style="cursor: pointer;" (click)="closeFilter()"></i>
    </div>

    <div class="filter-body">
      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('country') }}</label>
        <select class="form-select text-muted">
          <option selected>{{ t('selectCountry') }}</option>
          <option value="sa">{{ t('saudiArabia') }}</option>
          <option value="eg">{{ t('egypt') }}</option>
        </select>
      </div>

      <div class="row mb-3">
        <div class="col-6">
          <label class="form-label text-muted small">{{ t('city') }}</label>
          <select class="form-select text-muted">
            <option selected>{{ t('selectCity') }}</option>
            <option value="jeddah">{{ t('jeddah') }}</option>
            <option value="riyadh">{{ t('riyadh') }}</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label text-muted small">{{ t('region') }}</label>
          <select class="form-select text-muted">
            <option selected>{{ t('selectRegion') }}</option>
            <option value="makkah">{{ t('makkahRegion') }}</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('status') }}</label>
        <select class="form-select text-muted">
          <option selected>{{ t('selectStatus') }}</option>
          <option value="active">{{ t('active') }}</option>
          <option value="inactive">{{ t('inactive') }}</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label text-muted small">{{ t('newSubscribers') }}</label>
        <input type="text" class="form-control" [placeholder]="t('eg30Days')">
      </div>

      <div class="mb-4">
        <label class="form-label text-muted small">{{ t('subscriptionEnding') }}</label>
        <input type="text" class="form-control" [placeholder]="t('eg15Days')">
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <button class="btn text-success fw-bold" (click)="resetFilter()">{{ t('reset') }}</button>
      <button class="btn btn-success px-4" (click)="applyFilter()">{{ t('applyFilters') }}</button>
    </div>

  </div>
</div>
</div></div>
  </div>

</div>
<div class="filter-overlay" *ngIf="showAddUserModal" [dir]="currentLang === 'ar' ? 'rtl' : 'ltr'">
  <div class="filter-modal modal-lg" (click)="$event.stopPropagation()">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-start mb-4">
      <div>
        <h4 class="fw-bold mb-1">
          <span *ngIf="currentStep === 1">{{ t('addNewSubscriberTitle') }}</span>
          <span *ngIf="currentStep === 2">{{ t('licenseInfoTitle') }}</span>
          <span *ngIf="currentStep === 3">{{ t('legalEntityTitle') }}</span>
          <span *ngIf="currentStep === 4">{{ t('subscriptionBillingTitle') }}</span>
          <span *ngIf="currentStep === 5">{{ t('technicalInfoTitle') }}</span>
        </h4>
        <p class="text-muted small mb-0">
          <span *ngIf="currentStep === 1">{{ t('addNewSubscriberDesc') }}</span>
          <span *ngIf="currentStep === 2">{{ t('licenseInfoDesc') }}</span>
          <span *ngIf="currentStep === 3">{{ t('legalEntityDesc') }}</span>
          <span *ngIf="currentStep === 4">{{ t('subscriptionBillingDesc') }}</span>
          <span *ngIf="currentStep === 5">{{ t('technicalInfoDesc') }}</span>
        </p>
      </div>
      <div class="d-flex flex-column align-items-end">
        <i class="fas fa-times text-muted fs-5 mb-2" style="cursor: pointer;" (click)="closeAddUserModal()"></i>
        <span class="fw-bold small">{{ t('step') }} {{currentStep}} {{ t('of') }} {{totalSteps}}</span>
      </div>
    </div>

    <!-- BODY -->
    <div class="wizard-body">

      <!-- STEP 1 -->
      <div *ngIf="currentStep === 1">
        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('country') }}</label>
            <select class="form-select" [(ngModel)]="formData.countryId" (change)="onCountryChange()">
  <option value="">{{ t('selectCountry') }}</option>
  <option *ngFor="let c of countries" [value]="c.id">{{ c.name }}</option>
</select>

        </div>

        <div class="row mb-4">
          <div class="col-12">
            <label class="form-label text-muted small">{{ t('city') }}</label>
              <select class="form-select"
              [(ngModel)]="formData.cityId"
              (change)="onCityChange()">

        <option value="">{{ t('selectCity') }}</option>

        <option *ngFor="let city of cities" [value]="city.id">
          {{ city.name }}
        </option>

      </select>
          </div>
          <!-- <div class="col-6">
            <label class="form-label text-muted small">{{ t('region') }}</label>
              <select class="form-select"
              [(ngModel)]="formData.regionId">

        <option value="">{{ t('selectRegion') }}</option>

        <option *ngFor="let r of regions" [value]="r.id">
          {{ r.name }}
        </option>

      </select>
          </div> -->
        </div>

        <!-- STATIC LINKS (unchanged) -->
        <div class="row g-3" *ngIf="countryLinks.length > 0">
  <div class="col-6" *ngFor="let link of countryLinks">
    <div class="d-flex align-items-start gap-2">
      <i class="fas fa-building text-muted mt-1"></i>
      <div>
        <div class="fw-bold small">{{ link.name }}</div>
        <a [href]="link.url" target="_blank" class="text-muted x-small text-decoration-none">{{ link.url }}</a>
      </div>
    </div>
  </div>
</div>

      </div>

      <!-- STEP 2 -->
      <div *ngIf="currentStep === 2">

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('licenseName') }}</label>
          <input type="text" class="form-control" [(ngModel)]="formData.licenseName">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('licenseNumber') }}</label>
          <input type="text" class="form-control" [(ngModel)]="formData.licenseNumber">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('licenseDate') }}</label>
          <input type="date" class="form-control text-muted" [(ngModel)]="formData.licenseDate">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('licenseType') }}</label>
          <select class="form-select" [(ngModel)]="formData.licenseType">
            <option value="">{{ t('selectLicenseType') }}</option>
            <option value="Company">مراجع قانوني</option>
            <option value="Office">مهني اخر</option>
            <option value="Office">بدون</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('licenseCertificate') }}</label>
          <input type="file" class="form-control" (change)="onFileSelect($event, 'licenseCertificate')">
        </div>

      </div>

      <!-- STEP 3 -->
      <div *ngIf="currentStep === 3">

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('ownersName') }}</label>
          <input class="form-control" [(ngModel)]="formData.ownersNames">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('subscriberEmail') }}</label>
          <input class="form-control" [(ngModel)]="formData.subscriberEmail">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('mobile') }}</label>
          <input class="form-control" [(ngModel)]="formData.primaryMobile">
        </div>

        <!-- <div class="mb-3">
          <label class="form-label text-muted small">{{ t('subscriberStatus') }}</label>
          <select class="form-select" [(ngModel)]="formData.status">
            <option value="">{{ t('selectSubscriberStatus') }}</option>
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </div> -->

        <!-- entity -->
        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('legalEntityType') }}</label>
          <select class="form-control" [(ngModel)]="formData.legalEntityType">
            <option value="">اختر النوع</option>
            <option value="مراجع قانوني">مراجع قانوني</option>
            <option value="استشارات">استشارات</option>
            <option value="فردي">فردي</option>
          </select>
        </div>

        <div class="mb-3">
  <label class="form-label text-muted small">{{ t('legalEntityNationality') }}</label>
  <input class="form-control" [(ngModel)]="formData.legalEntityNationality" readonly>
</div>

        <!-- TAX NUMBER + FILE -->
        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('taxNumber') }}</label>
          <input type="text" class="form-control mb-2" [(ngModel)]="formData.taxNumber">
          <input type="file" class="form-control" (change)="onFileSelect($event,'taxCertificateFile')">
        </div>

        <!-- DATES -->

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('fiscalYear') }}</label>
          <input type="date" class="form-control text-muted" [(ngModel)]="formData.fiscalYear">
        </div>

        <!-- Unified -->
        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('unifiedNumber') }}</label>
          <input type="text" class="form-control mb-2" [(ngModel)]="formData.unifiedNumber">
          <!-- <input type="file" class="form-control" (change)="onFileSelect($event,'unifiedNumberFile')"> -->
        </div>

        <!-- Activity -->
        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('commRegisterActivity') }}</label>
          <input type="text" class="form-control mb-2" [(ngModel)]="formData.commercialActivity">
          <input type="file" class="form-control" (change)="onFileSelect($event,'commercialActivityFile')">
        </div>
        <div class="mb-3">
          <label class="form-label text-muted small"> {{ t('commRegisternumber') }}</label>
          <input type="text" class="form-control mb-2" [(ngModel)]="formData.commercialRegisterNumber">
        </div>
        <div class="mb-3">
  <label class="form-label text-muted small fw-bold mb-2">{{ t('commRegisterDate') }}</label>
  <div class="row g-2 align-items-end">
    <div class="col-6">
      <div class="input-wrapper">
        <label class="x-small-label text-muted">هجري</label>
        <mat-form-field appearance="outline" class="w-100" subscriptSizing="dynamic">
          <input
            matInput
            [matDatepicker]="regPickerHijri"
            [(ngModel)]="formData.commercialRegisterDate"
            (dateChange)="syncFromHijri('commercialRegisterDate', $event.value)"
            placeholder="يوم/شهر/سنة"
          />
          <mat-datepicker-toggle matSuffix [for]="regPickerHijri"></mat-datepicker-toggle>
          <mat-datepicker #regPickerHijri></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="col-6">
      <div class="input-wrapper">
        <label class="x-small-label text-muted">ميلادي</label>
        <input
          type="date"
          class="form-control date-input-custom"
          [ngModel]="convertToGregorian(formData.commercialRegisterDate)"
          (ngModelChange)="syncFromGregorian('commercialRegisterDate', $event)"
        >
      </div>
    </div>
  </div>
</div>

<div class="mb-3">
  <label class="form-label text-muted small fw-bold mb-2">{{ t('commercialExpireDate') }}</label>
  <div class="row g-2 align-items-end">
    <div class="col-6">
      <div class="input-wrapper">
        <label class="x-small-label text-muted">هجري</label>
        <mat-form-field appearance="outline" class="w-100" subscriptSizing="dynamic">
          <input
            matInput
            [matDatepicker]="expPickerHijri"
            [(ngModel)]="formData.commercialExpireDate"
            (dateChange)="syncFromHijri('commercialExpireDate', $event.value)"
          />
          <mat-datepicker-toggle matSuffix [for]="expPickerHijri"></mat-datepicker-toggle>
          <mat-datepicker #expPickerHijri></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="col-6">
      <div class="input-wrapper">
        <label class="x-small-label text-muted">ميلادي</label>
        <input
          type="date"
          class="form-control date-input-custom"
          [ngModel]="convertToGregorian(formData.commercialExpireDate)"
          (ngModelChange)="syncFromGregorian('commercialExpireDate', $event)"
        >
      </div>
    </div>
  </div>
</div>
      </div>

      <!-- STEP 4 -->
      <div *ngIf="currentStep === 4">

<div class="row mb-3">
  <div class="col-12">
      <label class="form-label text-muted small">{{ t('startDate') }}</label>
      <input type="date" class="form-control" [(ngModel)]="formData.subscriptionStartDate">
    </div>
    <!-- <div class="col-6">
      <label class="form-label text-muted small">{{ t('endDate') }}</label>
      <input type="date" class="form-control" [(ngModel)]="formData.subscriptionEndDate">
    </div> -->
</div>
        <div class="mb-3">
  <label class="form-label text-muted small">{{ t('subPackage') }}</label>
  <select class="form-select" [(ngModel)]="formData.planId"
        (change)="onPlanChange($event)">
  <option value="">{{ t('selectSubPackage') }}</option>
  <option *ngFor="let plan of plans" [value]="plan.id">{{ plan.name }}</option>
</select>

</div>

<div class="mb-3">
  <label class="form-label text-muted small">{{ t('numOfUsers') }}</label>
  <input class="form-control" [(ngModel)]="formData.numberOfUsers" readonly>
</div>

<!-- <div class="mb-3">
  <label class="form-label text-muted small">{{ t('numOfFiles') }}</label>
  <input class="form-control" [(ngModel)]="formData.numberOfClients" readonly>
</div> -->

<div class="mb-3">
  <label class="form-label text-muted small">{{ t('numOfBranches') }}</label>
  <input class="form-control" [(ngModel)]="formData.numberOfBranches" readonly>
</div>
<div class="mb-3">
  <label class="form-label text-muted small">{{ t('fileLimit') }}</label>
  <input class="form-control" [(ngModel)]="formData.fileLimit" readonly>
</div>
<div class="mb-3">
  <label class="form-label text-muted small">{{ t('maxFileSizeMB') }}</label>
  <input class="form-control" [(ngModel)]="formData.maxFileSizeMB" readonly>
</div>
      </div>

      <!-- STEP 5 -->
      <div *ngIf="currentStep === 5">

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('facilityLink') }}</label>
          <input class="form-control" [(ngModel)]="formData.facilityLink">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('factoryLogo') }}</label>
          <input type="file" class="form-control" (change)="onFileSelect($event,'factoryLogo')">
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('language') }}</label>
          <select class="form-select" [(ngModel)]="formData.language">
            <option value="">{{ t('selectLanguage') }}</option>
            <option value="Arabic">Arabic</option>
            <option value="English">English</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">{{ t('currencySettings') }}</label>
          <input class="form-control" [(ngModel)]="formData.currency" readonly>
        </div>

      </div>

    </div>

    <!-- FOOTER BUTTONS -->
    <div class="d-flex justify-content-end align-items-center gap-3 mt-5">
  <button class="btn border px-4" *ngIf="currentStep > 1" (click)="prevStep()">{{ t('back') }}</button>
  <button class="btn btn-success px-4" *ngIf="currentStep < totalSteps" (click)="nextStep()">{{ t('next') }}</button>

  <button class="btn btn-success px-4" *ngIf="currentStep === totalSteps" (click)="submitNewUser()">
    {{ isEditMode ? t('update') : t('submit') }}
  </button>
</div>
  </div>
</div>

<!-- SUCCESS MODAL -->
<div class="filter-overlay" *ngIf="submissionStatus === 'success'">
  <div class="filter-modal modal-sm text-center p-4">

    <h4 class="fw-bold mb-2">{{ t('subscriberCreated') }}</h4>
    <p class="text-muted mb-4">{{ t('yourSystemLink') }}</p>

    <div class="input-group mb-4">
      <input class="form-control text-center fw-bold" [value]="generatedLink" readonly>
      <button class="btn btn-success" (click)="copyLink()">{{ t('copy') }}</button>
    </div>

    <button class="btn btn-success w-100 mb-2" (click)="closeSuccessModal()">{{ t('goToSubscribers') }}</button>
    <button class="btn btn-light w-100" (click)="resetAndAddAnother()">{{ t('addAnother') }}</button>

  </div>
</div>

<div class="filter-overlay" *ngIf="submissionStatus === 'success'">
  <div class="filter-modal" style="max-width: 600px;" (click)="$event.stopPropagation()">

    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <h4 class="fw-bold mb-1">{{ t('subscriberCreated') }}</h4>
        <p class="text-muted small">{{ t('subscriberCreatedDesc') }}</p>
      </div>
      <i class="fas fa-times text-muted fs-5" style="cursor: pointer;" (click)="closeSuccessModal()"></i>
    </div>

    <hr class="text-muted opacity-25 mb-4">

    <div class="mb-4">
      <label class="form-label text-muted small">{{ t('subscriberLink') }}</label>
      <div class="input-group link-group">
        <span class="input-group-text border-0 fw-bold small">{{ t('url') }}</span>
        <input type="text" class="form-control border-0 bg-transparent" [value]="generatedLink" readonly>
        <button class="btn btn-success copy-btn" (click)="copyLink()">
          <i class="far fa-copy"></i>
        </button>
      </div>
    </div>

    <div class="d-flex gap-3 mt-5">
      <button class="btn btn-outline-secondary w-50 py-2" (click)="resetAndAddAnother()">{{ t('addAnotherSubscriber') }}</button>
      <button class="btn btn-success w-50 py-2" (click)="closeSuccessModal()">{{ t('goToSubscribersList') }}</button>
    </div>

  </div>
</div>
<div class="filter-overlay" *ngIf="showReminderModal">
  <div class="filter-modal" style="max-width: 400px;" (click)="$event.stopPropagation()">

    <div class="d-flex justify-content-center mb-3">
      <div class="icon-circle-bg">
        <i class="fas fa-sync-alt text-success fs-4"></i>
      </div>
    </div>

    <div class="text-start mb-3">
      <h5 class="fw-bold mb-2">{{ t('sendReminder') }}</h5>
      <p class="text-muted small mb-0">{{ t('reminderDesc') }}</p>
    </div>

    <div class="d-flex flex-column gap-3 mb-4">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="remEmail" [(ngModel)]="reminderOptions.email">
        <label class="form-check-label small" for="remEmail">{{ t('sendViaEmail') }}</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="remPhone" [(ngModel)]="reminderOptions.phone">
        <label class="form-check-label small" for="remPhone">{{ t('sendViaPhone') }}</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="remSystem" [(ngModel)]="reminderOptions.system">
        <label class="form-check-label small" for="remSystem">{{ t('sendViaSystem') }}</label>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary w-50" (click)="closeReminderModal()">{{ t('cancel') }}</button>
      <button class="btn btn-success w-50" (click)="confirmReminder()">{{ t('confirm') }}</button>
    </div>

  </div>
</div>
<!-- ================= Subscriber Overlay ================ -->
<div
  class="overlay-container"
  *ngIf="showSubscriberOverlay"
>
  <div class="overlay-content">

    <!-- Close Button -->
    <button class="close-btn" (click)="closeSubscriberOverlay()">✕</button>

    <h3 class="mb-3">Subscriber Details</h3>

    <div class="details-grid">
  <div><strong>Name:</strong> {{ selectedSubscriber?.licenseName }}</div>
  <div><strong>Email:</strong> {{ selectedSubscriber?.subscriberEmail }}</div>
  <div><strong>Mobile:</strong> {{ selectedSubscriber?.primaryMobile }}</div>

  <div><strong>Country:</strong> {{ selectedSubscriber?.country?.name }}</div>
  <div><strong>City:</strong> {{ selectedSubscriber?.city?.name }}</div>
  <!-- <div><strong>Region:</strong> {{ selectedSubscriber?.region?.name }}</div> -->

  <div><strong>License Number:</strong> {{ selectedSubscriber?.licenseNumber }}</div>
  <div><strong>License Date:</strong> {{ selectedSubscriber?.licenseDate | date:'yyyy-MM-dd' }}</div>
  <div><strong>License Type:</strong> {{ selectedSubscriber?.licenseType }}</div>
  <div><strong>Legal Entity:</strong> {{ selectedSubscriber?.legalEntityType }}</div>
  <div><strong>Nationality:</strong> {{ selectedSubscriber?.legalEntityNationality }}</div>
  <div><strong>Owners:</strong> {{ selectedSubscriber?.ownersNames }}</div>
  <div><strong>Commercial Register Number:</strong> {{ selectedSubscriber?.commercialRegisterNumber }}</div>
  <div><strong>Commercial Register Date:</strong> {{ selectedSubscriber?.commercialRegisterDate | date:'yyyy-MM-dd' }}</div>

  <div><strong>Tax Number:</strong> {{ selectedSubscriber?.taxNumber }}</div>
  <div><strong>Unified Number:</strong> {{ selectedSubscriber?.unifiedNumber }}</div>
  <div><strong>Fiscal Year:</strong> {{ selectedSubscriber?.fiscalYear | date:'yyyy-MM-dd' }}</div>

  <div><strong>Subscription Start:</strong>
       {{ selectedSubscriber?.subscriptionStartDate ? (selectedSubscriber.subscriptionStartDate | date:'yyyy-MM-dd') : '—' }}
  </div>
  <div><strong>Subscription End:</strong>
       {{ selectedSubscriber?.subscriptionEndDate ? (selectedSubscriber.subscriptionEndDate | date:'yyyy-MM-dd') : '—' }}
  </div>

  <div><strong>Status:</strong> {{ selectedSubscriber?.status }}</div>
  <div><strong>Plan:</strong> {{ selectedSubscriber?.plan?.name }}</div>
  <div><strong>Paid Fees:</strong> {{ selectedSubscriber?.plan?.paidFees || '—' }}</div>
  <div><strong>Users Limit:</strong> {{ selectedSubscriber?.plan?.usersLimit || '—' }}</div>
  <!-- <div><strong>Clients Limit:</strong> {{ selectedSubscriber?.plan?.clientsLimit || '—' }}</div> -->
  <div><strong>Branches Limit:</strong> {{ selectedSubscriber?.plan?.branchesLimit || '—' }}</div>

  <div><strong>Subdomain:</strong> {{ selectedSubscriber?.subdomain }}</div>
  <div><strong>Facility Link:</strong> {{ selectedSubscriber?.facilityLink || '—' }}</div>
  <!-- <div><strong>Language:</strong> {{ selectedSubscriber?.language || '—' }}</div> -->
  <div><strong>Currency:</strong> {{ selectedSubscriber?.currency || '—' }}</div>
  <!-- <div><strong>Internal Notes:</strong> {{ selectedSubscriber?.internalNotes || '—' }}</div> -->

  <!-- الملفات -->
  <div><strong>License Certificate:</strong>
       <a *ngIf="selectedSubscriber?.licenseCertificate"
          [href]="api_url + '/' + selectedSubscriber.licenseCertificate" target="_blank">
          View
       </a>
  </div>
  <!-- <div><strong>Commercial Register File:</strong>
       <a *ngIf="selectedSubscriber?.commercialRegisterFile"
          [href]="api_url + '/' + selectedSubscriber.commercialRegisterFile" target="_blank">
          View
       </a>
  </div> -->
  <div><strong>Tax Certificate:</strong>
       <a *ngIf="selectedSubscriber?.taxCertificateFile"
          [href]="api_url + '/' + selectedSubscriber.taxCertificateFile" target="_blank">
          View
       </a>
  </div>
  <!-- <div><strong>Unified Number File:</strong>
       <a *ngIf="selectedSubscriber?.unifiedNumberFile"
          [href]="api_url + '/' + selectedSubscriber.unifiedNumberFile" target="_blank">
          View
       </a>
  </div> -->
  <div><strong>Commercial Activity File:</strong>
       <a *ngIf="selectedSubscriber?.commercialActivityFile"
          [href]="api_url + '/' + selectedSubscriber.commercialActivityFile" target="_blank">
          View
       </a>
  </div>

  <!-- صورة المصنع -->
  <div class="image-box">
    <strong>Factory Logo:</strong><br>
    <img *ngIf="selectedSubscriber?.factoryLogo"
         [src]="api_url + '/' + selectedSubscriber.factoryLogo"
         class="preview-img">
  </div>
</div>

  </div>
</div>
<div class="modal-overlay" *ngIf="isExportModalOpen">
  <div class="export-modal-container">

    <div class="export-header">
      <h3>{{ t('exportTitle') }}</h3>
      <button class="close-btn" (click)="closeExportModal()">×</button>
    </div>

    <p class="export-subtitle">{{ t('selectFileType') }}</p>


      <div class="export-options-grid">

  <!-- Excel -->
  <div class="export-option-card"
       [class.selected]="selectedExportOption==='excel'"
       (click)="selectExportOption('excel')">
    <div class="file-icon green">
      <i class="fa-solid fa-file-excel"></i>
    </div>
    <span>Excel file</span>
  </div>

  <!-- PDF -->
  <div class="export-option-card"
       [class.selected]="selectedExportOption==='pdf'"
       (click)="selectExportOption('pdf')">
    <div class="file-icon red">
      <i class="fa-solid fa-file-pdf"></i>
    </div>
    <span>PDF file</span>
  </div>

</div>


    <div class="export-footer">
      <button class="btn-primary download-btn" (click)="handleExport()">
    <i class="fa-solid fa-download"></i> {{ t('download') }}
</button>
    </div>

  </div>
</div>
